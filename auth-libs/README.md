# HOTOSM Auth Libraries

Shared authentication libraries for all HOTOSM projects.

## Contents

### 1. Python Library (`python/`)

**Python library** for FastAPI and Django integration.

**Installation** (in your `pyproject.toml`):
```python
dependencies = [
    "hotosm-auth @ git+https://github.com/LawalCoop/hot-auth-libs.git@v0.1.11#subdirectory=python",
]
```

**Usage**:
```python
from hotosm_auth.integrations.fastapi import CurrentUser

@router.get("/me")
async def get_me(user: CurrentUser):
    return {"id": user.id, "email": user.email}
```

Full documentation: [python/README.md](./python/README.md)

---

### 2. Web Component (`web-component/`)

**Web component** for the frontend (HTML/JS).

**Usage**:
```html
<head>
    <meta name="hanko-url" content="https://login.hotosm.org">
    <script src="auth-libs/web-component/dist/hanko-auth.iife.js"></script>
</head>
<body>
    <hotosm-auth show-profile></hotosm-auth>
</body>
```

Full documentation: [web-component/README.md](./web-component/README.md)

---

## Distribution

Auth-libs uses two different distribution methods:

### Python (Backend)

**Method**: Git+HTTPS with version tags

Projects reference auth-libs directly from GitHub:
```python
"hotosm-auth @ git+https://github.com/LawalCoop/hot-auth-libs.git@v0.1.11#subdirectory=python",
```

- No wheels to distribute or commit
- `uv lock` regenerates the lockfile with the specified version

### Web Component (Frontend)

**Method**: Build and distribute via script

JS bundles are copied to each project:
```bash
./scripts/build.sh      # Build JS bundles
./scripts/distribute.sh # Copy to all projects
```

- Files are committed in each project
- Required for local hot-reload and Docker builds

---

## Releasing a New Version

### 1. Make changes

Edit source code:
- Python: `python/hotosm_auth/`
- Web component: `web-component/src/`

### 2. Update version

Edit `python/pyproject.toml`:
```toml
version = "0.1.9"  # bump from 0.1.8
```

### 3. Build and distribute

```bash
./scripts/build.sh      # Build Python wheel + JS bundles
./scripts/distribute.sh # Copy dist/ to projects AND update pyproject.toml
```

The `distribute.sh` script automatically:
- Copies web component dist/ to all frontends
- Copies Python dist/ to all backends
- **Updates `pyproject.toml` references in all projects** to the current version

### 4. Commit and tag

```bash
git add .
git commit -m "Add new feature"
git push
git tag v0.1.9
git push --tags
```

### 5. Commit in all projects

In each project, commit the changes generated by `distribute.sh`:
```bash
git add frontend/auth-libs/ backend/pyproject.toml
git commit -m "Update auth-libs to v0.1.9"
git push
```

---

## Configuration

### Backend (.env)
```bash
HANKO_API_URL=https://login.hotosm.org
COOKIE_SECRET=your-secret-key-min-32-bytes

# Optional - OSM OAuth
OSM_CLIENT_ID=your-osm-client-id
OSM_CLIENT_SECRET=your-osm-client-secret
```

### Frontend (HTML)
```html
<meta name="hanko-url" content="https://login.hotosm.org">
<script src="auth-libs/web-component/dist/hanko-auth.iife.js"></script>
<hotosm-auth></hotosm-auth>
```

### Web Component Attributes

#### Core

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `hanko-url` | string | `window.location.origin` | Hanko API URL for SDK initialization and JWT validation |
| `login-url` | string | `${hanko-url}/app` | Login page URL (override for standalone mode) |
| `base-path` | string | `""` | Base URL for OSM OAuth endpoints |
| `auth-path` | string | `/api/auth/osm` | OSM auth endpoints path (appended to base-path) |

#### Behavior

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `osm-required` | boolean | `false` | Require OSM connection after login |
| `osm-scopes` | string | `"read_prefs"` | Space-separated OSM scopes |
| `auto-connect` | boolean | `false` | Auto-redirect to OSM OAuth |
| `verify-session` | boolean | `false` | Verify session on return |

#### Display

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `show-profile` | boolean | `false` | Show embedded form (login page mode) |
| `display-name` | string | `""` | Override display name |

#### Redirects

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `redirect-after-login` | string | `""` | URL to redirect after login |
| `redirect-after-logout` | string | `""` | URL to redirect after logout |

#### Cross-app

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `mapping-check-url` | string | `""` | URL to check user mapping |
| `app-id` | string | `""` | App identifier for onboarding redirect |

**Usage modes:**

1. **SSO Mode** (production): Points to login.hotosm.org
   ```html
   <hotosm-auth hanko-url="https://login.hotosm.org"></hotosm-auth>
   ```

2. **Standalone Mode** (development): Local Hanko + local login page
   ```html
   <hotosm-auth
     hanko-url="http://localhost:8002"
     login-url="http://localhost:5173/app"
   ></hotosm-auth>
   ```

---

## Projects using auth-libs

### Backend (Python)

| Project | File |
|---------|------|
| portal | `backend/pyproject.toml` |
| drone-tm | `src/backend/pyproject.toml` |
| fAIr | `backend/pyproject.toml` |
| openaerialmap | `backend/stac-api/pyproject.toml` |

### Frontend (Web Component)

| Project | Location |
|---------|----------|
| portal | `frontend/auth-libs/web-component/dist/` |
| drone-tm | `src/frontend/auth-libs/web-component/dist/` |
| fAIr | `frontend/auth-libs/web-component/dist/` |
| openaerialmap | `frontend/auth-libs/web-component/dist/` |
| login | `frontend/auth-libs/web-component/dist/` |

---

## Licenses

- **Python library** (`python/`): GPL-3.0-or-later
- **Web component** (`web-component/`): AGPL-3.0

See LICENSE files in each folder.
